import React, { useState, useMemo } from 'react'
import { BrowserRouter, Routes, Route, Link, useNavigate, useParams } from 'react-router-dom'

// ---------- Mock data ----------
const SAMPLE_PRODUCTS = [
  { id: 'p1', title: 'Env Sensor A1', price: 49.99, img: '', stock: 34, fw: '1.3.2', desc: 'Wireless environmental sensor with temp & humidity.' },
  { id: 'p2', title: 'Smart Plug P9', price: 19.9, img: '', stock: 120, fw: '2.0.1', desc: 'Remote controllable smart plug with energy monitoring.' },
  { id: 'p3', title: 'Gateway G3', price: 299.0, img: '', stock: 8, fw: '3.4.0', desc: 'Edge gateway for aggregating sensors and secure uplink.' },
]

const SAMPLE_ORDERS = [
  { orderId: 'ORD-1001', items: [{ id: 'p1', q: 2 }], total: 99.98, date: '2025-08-01', status: 'Shipped' },
  { orderId: 'ORD-1002', items: [{ id: 'p2', q: 3 }], total: 59.7, date: '2025-08-12', status: 'Processing' },
]

// ---------- App ----------
export default function App() {
  const [products] = useState(SAMPLE_PRODUCTS)
  const [orders, setOrders] = useState(SAMPLE_ORDERS)
  const [cart, setCart] = useState([])

  const addToCart = (product, qty = 1) => {
    setCart((c) => {
      const found = c.find(x => x.id === product.id)
      if (found) return c.map(x => x.id === product.id ? { ...x, q: x.q + qty } : x)
      return [{ id: product.id, title: product.title, price: product.price, q: qty }, ...c]
    })
  }

  const removeFromCart = (id) => setCart(c => c.filter(x => x.id !== id))

  const placeOrder = (customer) => {
    const total = cart.reduce((s, it) => s + it.price * it.q, 0)
    const newOrder = { orderId: 'ORD-' + (1000 + orders.length + 1), items: cart, total, date: new Date().toISOString().slice(0,10), status: 'Processing', customer }
    setOrders([newOrder, ...orders])
    setCart([])
    return newOrder.orderId
  }

  return (
    <BrowserRouter>
      <div className="min-h-screen bg-slate-50 text-slate-900">
        <Nav cartCount={cart.length} />
        <main className="max-w-6xl mx-auto p-6">
          <Routes>
            <Route path="/" element={<Shop products={products} addToCart={addToCart} />} />
            <Route path="/product/:id" element={<ProductDetail products={products} addToCart={addToCart} />} />
            <Route path="/checkout" element={<Checkout cart={cart} removeFromCart={removeFromCart} placeOrder={placeOrder} />} />
            <Route path="/dashboard" element={<Dashboard products={products} orders={orders} />} />
            <Route path="*" element={<NotFound />} />
          </Routes>
        </main>
        <footer className="text-center p-4 text-sm text-slate-600">© {new Date().getFullYear()} IoT E-Commerce Demo</footer>
      </div>
    </BrowserRouter>
  )
}

// ---------- Nav ----------
function Nav({ cartCount }) {
  return (
    <header className="bg-white shadow-sm">
      <div className="max-w-6xl mx-auto p-4 flex items-center justify-between">
        <Link to="/" className="font-bold text-xl">IoT Store</Link>
        <nav className="flex items-center gap-4">
          <Link to="/dashboard" className="text-sm">Dashboard</Link>
          <Link to="/" className="text-sm">Shop</Link>
          <Link to="/checkout" className="text-sm">Checkout</Link>
          <div className="px-3 py-1 bg-slate-100 rounded">Cart: {cartCount}</div>
        </nav>
      </div>
    </header>
  )
}

// ---------- Pages ----------
function Shop({ products, addToCart }) {
  return (
    <section>
      <div className="flex items-center justify-between mb-6">
        <h2 className="text-2xl font-semibold">Shop</h2>
        <p className="text-sm text-slate-600">{products.length} products</p>
      </div>

      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {products.map(p => (
          <div key={p.id} className="bg-white rounded shadow-sm p-4">
            <div className="h-40 bg-slate-100 rounded flex items-center justify-center mb-4">Image</div>
            <h3 className="font-semibold">{p.title}</h3>
            <p className="text-sm text-slate-600">{p.desc}</p>
            <div className="mt-3 flex items-center justify-between">
              <div className="font-bold">${p.price.toFixed(2)}</div>
              <div className="flex gap-2">
                <Link to={`/product/${p.id}`} className="px-3 py-1 border rounded text-sm">View</Link>
                <button onClick={() => addToCart(p)} className="px-3 py-1 bg-indigo-600 text-white rounded text-sm">Add</button>
              </div>
            </div>
          </div>
        ))}
      </div>
    </section>
  )
}

function ProductDetail({ products, addToCart }) {
  const { id } = useParams()
  const p = products.find(x => x.id === id)
  const navigate = useNavigate()
  if (!p) return <NotFound />

  return (
    <section>
      <div className="flex gap-8">
        <div className="w-1/3 bg-white rounded p-4">Image</div>
        <div className="flex-1 bg-white rounded p-6">
          <h2 className="text-2xl font-semibold">{p.title}</h2>
          <p className="text-slate-600">Firmware: {p.fw} • Stock: {p.stock}</p>
          <p className="mt-4">{p.desc}</p>
          <div className="mt-6 flex items-center gap-4">
            <div className="text-2xl font-bold">${p.price.toFixed(2)}</div>
            <button onClick={() => { addToCart(p); navigate('/checkout') }} className="px-4 py-2 bg-green-600 text-white rounded">Buy now</button>
            <button onClick={() => addToCart(p)} className="px-4 py-2 border rounded">Add to cart</button>
          </div>
        </div>
      </div>
    </section>
  )
}

function Checkout({ cart, removeFromCart, placeOrder }) {
  const navigate = useNavigate()
  const total = cart.reduce((s, it) => s + it.price * it.q, 0)
  const [loading, setLoading] = useState(false)
  const [customer, setCustomer] = useState({ name: '', email: '' })

  const onSubmit = (e) => {
    e.preventDefault()
    if (!customer.name || !customer.email || cart.length === 0) return alert('Complete info and cart.')
    setLoading(true)
    setTimeout(() => {
      const orderId = placeOrder(customer)
      setLoading(false)
      alert('Order placed: ' + orderId)
      navigate('/dashboard')
    }, 900)
  }

  return (
    <section>
      <h2 className="text-2xl font-semibold mb-4">Checkout</h2>
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div className="md:col-span-2 bg-white rounded p-4">
          {cart.length === 0 ? <p className="text-slate-500">Cart is empty.</p> : (
            <div>
              {cart.map(it => (
                <div key={it.id} className="flex items-center justify-between p-2 border-b">
                  <div>
                    <div className="font-semibold">{it.title}</div>
                    <div className="text-sm text-slate-500">Qty: {it.q}</div>
                  </div>
                  <div className="text-right">
                    <div>${(it.price * it.q).toFixed(2)}</div>
                    <button className="text-sm text-red-600" onClick={() => removeFromCart(it.id)}>Remove</button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>

        <div className="bg-white rounded p-4">
          <form onSubmit={onSubmit} className="space-y-4">
            <div>
              <label className="block text-sm">Name</label>
              <input required value={customer.name} onChange={e => setCustomer({...customer, name: e.target.value})} className="w-full border p-2 rounded" />
            </div>
            <div>
              <label className="block text-sm">Email</label>
              <input required value={customer.email} onChange={e => setCustomer({...customer, email: e.target.value})} className="w-full border p-2 rounded" />
            </div>
            <div className="border-t pt-4">
              <div className="flex justify-between text-sm"><span>Subtotal</span><span>${total.toFixed(2)}</span></div>
              <div className="flex justify-between text-sm"><span>Shipping</span><span>${total > 200 ? '0.00' : '10.00'}</span></div>
              <div className="flex justify-between font-bold text-lg mt-2"><span>Total</span><span>${(total + (total > 200 ? 0 : 10)).toFixed(2)}</span></div>
            </div>

            <button disabled={loading} className="w-full bg-indigo-600 text-white py-2 rounded">{loading ? 'Placing...' : 'Place Order'}</button>
          </form>
        </div>
      </div>
    </section>
  )
}

function Dashboard({ products, orders }) {
  const totalRevenue = orders.reduce((s, o) => s + (o.total || 0), 0)
  const totalOrders = orders.length
  const lowStock = products.filter(p => p.stock < 10).length

  return (
    <section>
      <div className="flex items-center justify-between mb-6">
        <h2 className="text-2xl font-semibold">Admin Dashboard</h2>
        <div className="text-sm text-slate-500">Overview</div>
      </div>

      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
        <div className="p-4 bg-white rounded shadow-sm">
          <div className="text-sm text-slate-500">Revenue</div>
          <div className="text-2xl font-bold">${totalRevenue.toFixed(2)}</div>
        </div>
        <div className="p-4 bg-white rounded shadow-sm">
          <div className="text-sm text-slate-500">Orders</div>
          <div className="text-2xl font-bold">{totalOrders}</div>
        </div>
        <div className="p-4 bg-white rounded shadow-sm">
          <div className="text-sm text-slate-500">Low stock</div>
          <div className="text-2xl font-bold">{lowStock}</div>
        </div>
      </div>

      <div className="bg-white rounded p-4">
        <h3 className="font-semibold mb-3">Recent Orders</h3>
        <table className="w-full text-left">
          <thead>
            <tr className="text-sm text-slate-500 border-b"><th className="py-2">Order ID</th><th>Date</th><th>Total</th><th>Status</th></tr>
          </thead>
          <tbody>
            {orders.map(o => (
              <tr key={o.orderId} className="border-b">
                <td className="py-2">{o.orderId}</td>
                <td>{o.date}</td>
                <td>${o.total.toFixed(2)}</td>
                <td>{o.status}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </section>
  )
}

function NotFound() {
  return (
    <div className="bg-white p-8 rounded text-center">
      <h3 className="text-xl font-semibold">Page not found</h3>
      <p className="text-slate-500">Try returning to the <Link to="/" className="text-indigo-600">home page</Link>.</p>
    </div>
  )
}
